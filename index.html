<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DFW Pilot – Installation Tracking Dashboard</title>

  <!-- Bootstrap 5 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <!-- SheetJS (xlsx) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --brand-blue: #003087;
      --brand-gold: #f5a623;
      --done-color: #198754;
      --removed-color: #dc3545;
      --replaced-color: #fd7e14;
      --other-color: #6c757d;
    }
    body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
    .navbar { background: var(--brand-blue) !important; }
    .navbar-brand { color: #fff !important; font-weight: 700; letter-spacing: .5px; }
    .navbar-brand span { color: var(--brand-gold); }

    /* Upload zone */
    #upload-zone {
      border: 3px dashed #adb5bd;
      border-radius: 12px;
      background: #fff;
      transition: border-color .25s, background .25s;
      cursor: pointer;
    }
    #upload-zone.dragover { border-color: var(--brand-blue); background: #e8f0ff; }
    #upload-zone .upload-icon { font-size: 3rem; color: #adb5bd; }
    #file-input { display: none; }

    /* KPI cards */
    .kpi-card { border-radius: 12px; border: none; transition: transform .2s; }
    .kpi-card:hover { transform: translateY(-4px); }
    .kpi-card .kpi-value { font-size: 2.2rem; font-weight: 700; }
    .kpi-card .kpi-label { font-size: .85rem; text-transform: uppercase; letter-spacing: .8px; opacity: .85; }

    /* Charts */
    .chart-card { border-radius: 12px; border: none; background: #fff; }
    .chart-card canvas { max-height: 280px; }

    /* Data table */
    #data-table-wrapper { overflow-x: auto; border-radius: 12px; background: #fff; }
    #data-table { font-size: .8rem; white-space: nowrap; }
    #data-table thead th {
      position: sticky; top: 0; z-index: 2;
      background: var(--brand-blue); color: #fff;
      font-weight: 600; padding: 8px 10px;
    }
    #data-table tbody tr:hover { background: #eef3ff; }
    .badge-done { background: var(--done-color); }
    .badge-removed { background: var(--removed-color); }
    .badge-replaced { background: var(--replaced-color); }
    .badge-other { background: var(--other-color); }

    /* Filter bar */
    .filter-bar { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
    .filter-bar select, .filter-bar input { font-size: .85rem; }

    /* Section headers */
    .section-title { font-weight: 700; color: var(--brand-blue); letter-spacing: .3px; }

    /* Trend info */
    #no-data-msg { display: none; }

    /* Footer */
    footer { font-size: .78rem; color: #6c757d; }

    @media (max-width: 768px) {
      .kpi-card .kpi-value { font-size: 1.6rem; }
    }
  </style>
</head>

<body>
<!-- ══════════ NAVBAR ══════════ -->
<nav class="navbar navbar-expand-lg shadow-sm mb-4">
  <div class="container-fluid px-4">
    <span class="navbar-brand"><i class="bi bi-truck me-2"></i>DFW <span>Pilot</span> Dashboard</span>
    <span class="text-white-50 small ms-auto" id="last-updated"></span>
  </div>
</nav>

<div class="container-fluid px-4">

  <!-- ══════════ UPLOAD ZONE ══════════ -->
  <div id="upload-section" class="mb-4">
    <div id="upload-zone" class="p-5 text-center" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon mb-2"><i class="bi bi-file-earmark-spreadsheet"></i></div>
      <h5 class="fw-semibold text-secondary">Upload End-of-Shift Excel File</h5>
      <p class="text-muted small mb-3">Drag &amp; drop your <strong>.xlsx</strong> or <strong>.xls</strong> file here, or click to browse</p>
      <button class="btn btn-outline-primary btn-sm px-4" onclick="event.stopPropagation();document.getElementById('file-input').click()">
        <i class="bi bi-upload me-1"></i>Choose File
      </button>
      <input type="file" id="file-input" accept=".xlsx,.xls,.csv" />
    </div>
    <div id="upload-error" class="alert alert-danger mt-2 d-none"></div>
  </div>

  <!-- ══════════ DASHBOARD (hidden until data loaded) ══════════ -->
  <div id="dashboard" class="d-none">

    <!-- Filters -->
    <div class="filter-bar shadow-sm mb-4">
      <div class="row g-2 align-items-end">
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">SCAC</label>
          <select id="filter-scac" class="form-select form-select-sm" style="min-width:130px"></select>
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">Program</label>
          <select id="filter-program" class="form-select form-select-sm" style="min-width:150px"></select>
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">Campaign Status</label>
          <select id="filter-status" class="form-select form-select-sm" style="min-width:160px"></select>
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">Domicile</label>
          <select id="filter-domicile" class="form-select form-select-sm" style="min-width:150px"></select>
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">Scheduled Date From</label>
          <input type="date" id="filter-date-from" class="form-control form-control-sm" />
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">To</label>
          <input type="date" id="filter-date-to" class="form-control form-control-sm" />
        </div>
        <div class="col-12 col-md-auto">
          <label class="form-label fw-semibold small mb-1">Search</label>
          <input type="text" id="filter-search" class="form-control form-control-sm" placeholder="Equipment ID / VIN…" style="min-width:180px" />
        </div>
        <div class="col-12 col-md-auto mt-1">
          <button class="btn btn-sm btn-secondary" id="btn-reset-filters"><i class="bi bi-x-circle me-1"></i>Reset</button>
        </div>
        <div class="col-12 col-md-auto mt-1 ms-md-auto">
          <button class="btn btn-sm btn-success" id="btn-export-csv"><i class="bi bi-download me-1"></i>Export Filtered CSV</button>
        </div>
      </div>
    </div>

    <!-- KPI cards -->
    <div class="row g-3 mb-4" id="kpi-row">
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:var(--brand-blue)">
          <div class="kpi-value" id="kpi-total">0</div>
          <div class="kpi-label">Total Vehicles</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:var(--done-color)">
          <div class="kpi-value" id="kpi-done">0</div>
          <div class="kpi-label">Done</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:var(--removed-color)">
          <div class="kpi-value" id="kpi-removed">0</div>
          <div class="kpi-label">Removed</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:var(--replaced-color)">
          <div class="kpi-value" id="kpi-replaced">0</div>
          <div class="kpi-label">Replaced</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:#0dcaf0">
          <div class="kpi-value" id="kpi-scheduled">0</div>
          <div class="kpi-label">Scheduled</div>
        </div>
      </div>
      <div class="col-6 col-md-3 col-xl-2">
        <div class="card kpi-card shadow-sm p-3 text-white" style="background:#6f42c1">
          <div class="kpi-value" id="kpi-completion">0%</div>
          <div class="kpi-label">Completion Rate</div>
        </div>
      </div>
    </div>

    <!-- Charts row 1 -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card chart-card shadow-sm p-3 h-100">
          <h6 class="section-title mb-3"><i class="bi bi-pie-chart-fill me-1"></i>Campaign Status</h6>
          <canvas id="chart-status"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card chart-card shadow-sm p-3 h-100">
          <h6 class="section-title mb-3"><i class="bi bi-bar-chart-fill me-1"></i>Installs by SCAC</h6>
          <canvas id="chart-scac"></canvas>
        </div>
      </div>
      <div class="col-12 col-md-12 col-xl-4">
        <div class="card chart-card shadow-sm p-3 h-100">
          <h6 class="section-title mb-3"><i class="bi bi-bar-chart-fill me-1"></i>Installs by Program</h6>
          <canvas id="chart-program"></canvas>
        </div>
      </div>
    </div>

    <!-- Charts row 2 -->
    <div class="row g-3 mb-4">
      <div class="col-12 col-xl-8">
        <div class="card chart-card shadow-sm p-3 h-100">
          <h6 class="section-title mb-3"><i class="bi bi-graph-up me-1"></i>Daily Installation Trend (Done)</h6>
          <canvas id="chart-trend" style="max-height:220px"></canvas>
        </div>
      </div>
      <div class="col-12 col-xl-4">
        <div class="card chart-card shadow-sm p-3 h-100">
          <h6 class="section-title mb-3"><i class="bi bi-bar-chart-steps me-1"></i>Installs by Body Type</h6>
          <canvas id="chart-bodytype"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow-sm mb-4 border-0" style="border-radius:12px">
      <div class="card-header bg-white border-bottom d-flex align-items-center gap-2" style="border-radius:12px 12px 0 0">
        <h6 class="section-title mb-0"><i class="bi bi-table me-1"></i>Vehicle Records</h6>
        <span class="badge bg-secondary ms-1" id="table-count-badge">0</span>
        <div class="ms-auto small text-muted">Showing up to <strong>1,000</strong> rows</div>
      </div>
      <div id="data-table-wrapper" class="p-0" style="max-height:480px;overflow-y:auto">
        <table class="table table-sm table-hover mb-0" id="data-table">
          <thead><tr id="table-head-row"></tr></thead>
          <tbody id="table-body"></tbody>
        </table>
        <p id="no-data-msg" class="text-center text-muted py-4">No records match your filters.</p>
      </div>
    </div>

  </div><!-- /dashboard -->
</div><!-- /container -->

<footer class="text-center py-3 mt-2">
  DFW Pilot Installation Tracker &mdash; upload an end-of-shift Excel to begin
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ============================================================
   CONFIGURATION – column names as they appear in the Excel header row
   ============================================================ */
const COL = {
  equipmentId   : 'Equipment ID',
  products      : 'Products Needed',
  program       : 'Program',
  scac          : 'SCAC',
  licensePlate  : 'License Plate',
  vin           : 'VIN',
  status        : 'Campaign Status Option (Done/Removed/Replaced)',
  domicile      : 'Domicile',
  latLon        : 'Location Lat/Lon (Per GRIT)',
  manufacture   : 'Manufacture',
  model         : 'Model',
  modelYear     : 'Model Year',
  bodyType      : 'Body Type',
  fuelType      : 'Fuel Type',
  lifecycleState: 'Lifecyle state reason',
  assetAvail    : 'Asset Availability',
  scheduleComm  : 'Communication of Schedule Sent',
  scheduledDate : 'Scheduled Date',
  availStart    : 'Availability to Start',
  availEnd      : 'Availability End Time',
  preInstall    : 'Pre-Installation D810 Visit',
  firstArticle  : 'First Article Required',
  sopNeed       : 'SOP Need',
  cableHarness  : 'Cable - Harness Part Number',
  canalyzer     : 'CANalyzer Needed',
  vbusSerial    : 'VBUS Serial Number',
  vbusInstall   : 'VBUS Install',
  vbusPart      : 'VBUS/VDR Part Number',
  ddtInstall    : 'DDT Install',
  ddtSerial     : 'DDT Serial Number',
  ddtPart       : 'DDT/DMS Part Number',
  ddtBracket    : 'DDT/DMS New Bracket Part Number',
  hapticSeat    : 'Haptic Seat - 15 units only',
  hapticPart    : 'Haptic Seat Part Number',
  cameraModel   : 'Camera Model Install',
  newCameraSerial: 'New Camera Serial Number',
  removedCamera : 'Removed/Returned Camera Serial Number',
  d450Part      : 'D450 - 200 Hour Part Number',
  dr20Part      : 'DR-20 Part Number',
  extCameras    : 'External Cameras (D810 Only)',
  l2CamPart     : 'L2 - External Camera Part Number',
  l2CamSerial   : 'L2 - External Camera Serial Number',
  r1CamPart     : 'R1  - External Camera Part Number',
  r1CamSerial   : 'R1 - External Camera Serial Number',
  r2CamPart     : 'R2  - External Camera Part Number',
  r2CamSerial   : 'R2 - External Camera Serial Number',
  boCamPart     : 'BO  - External Camera Part Number',
  boCamSerial   : 'BO  - External Camera Serial Number',
  extCamBracket : 'External Camera Bracket Part Number',
  inVehicleDisp : 'In-Vehicle Display (D810 only)',
  displayPart   : 'Internal Vehicle Display Part Number',
  driverBtn     : 'Driver Button Install',
  driverBtnPart : 'Driver Activation Button Part Number',
  verifiedIDMS  : 'Verified In IDMS',
  canCheck      : 'CAN Check Status',
  busLoad       : 'Acceptable BUS Load Number (goguend)',
  preBusLoad    : 'Pre VBUS Installation Bus Load',
  tracedBus     : 'Traced BUS Load Number',
  otrTest       : 'OTR or In-yard Test Results, if applicable',
  idmsPortal    : 'IDMS Portal Verification',
  netradyne     : 'Netradyne SOP Materials Collected',
  xirgo         : 'Xirgo Test',
  geotab        : 'Geotab',
  truckWings    : 'Truck Wings',
  mirrorEye     : 'MirrorEye',
  tda           : 'Tractor DriverAssist (TDA)',
};

/* All column labels in display order */
const ALL_COLS = Object.values(COL);

/* ============================================================
   STATE
   ============================================================ */
let rawData   = [];   // all rows parsed from Excel
let filtered  = [];   // rows after applying filters

let chartStatus, chartScac, chartProgram, chartTrend, chartBodyType;

/* ============================================================
   UPLOAD HANDLING
   ============================================================ */
const uploadZone = document.getElementById('upload-zone');
const fileInput  = document.getElementById('file-input');

uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
  e.preventDefault();
  uploadZone.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
});
fileInput.addEventListener('change', () => { if (fileInput.files[0]) processFile(fileInput.files[0]); });

function processFile(file) {
  const allowed = ['.xlsx', '.xls', '.csv'];
  const ext = file.name.includes('.') ? file.name.slice(file.name.lastIndexOf('.')).toLowerCase() : '';
  if (!allowed.includes(ext)) {
    showError('Please upload an Excel (.xlsx / .xls) or CSV file.');
    return;
  }
  hideError();
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      if (!rows.length) { showError('The file appears to be empty.'); return; }
      rawData = rows;
      initDashboard();
    } catch (err) {
      showError('Could not parse file: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

function showError(msg) {
  const el = document.getElementById('upload-error');
  el.textContent = msg;
  el.classList.remove('d-none');
}
function hideError() {
  document.getElementById('upload-error').classList.add('d-none');
}

/* ============================================================
   INIT
   ============================================================ */
function initDashboard() {
  document.getElementById('dashboard').classList.remove('d-none');
  document.getElementById('last-updated').textContent = 'Loaded: ' + new Date().toLocaleString();
  populateFilters();
  applyFilters();
}

/* ============================================================
   FILTERS
   ============================================================ */
function uniqueValues(col) {
  const set = new Set(rawData.map(r => String(r[col] ?? '').trim()).filter(Boolean));
  return ['All', ...Array.from(set).sort()];
}

function populateFilters() {
  fillSelect('filter-scac',     uniqueValues(COL.scac));
  fillSelect('filter-program',  uniqueValues(COL.program));
  fillSelect('filter-status',   uniqueValues(COL.status));
  fillSelect('filter-domicile', uniqueValues(COL.domicile));
}

function fillSelect(id, values) {
  const sel = document.getElementById(id);
  const prev = sel.value;
  sel.innerHTML = values.map(v => `<option value="${v}">${v}</option>`).join('');
  if (values.includes(prev)) sel.value = prev;
}

['filter-scac','filter-program','filter-status','filter-domicile',
 'filter-date-from','filter-date-to','filter-search'].forEach(id => {
  document.getElementById(id).addEventListener('change', applyFilters);
  document.getElementById(id).addEventListener('input',  applyFilters);
});

document.getElementById('btn-reset-filters').addEventListener('click', () => {
  ['filter-scac','filter-program','filter-status','filter-domicile'].forEach(id => {
    document.getElementById(id).value = 'All';
  });
  document.getElementById('filter-date-from').value = '';
  document.getElementById('filter-date-to').value   = '';
  document.getElementById('filter-search').value    = '';
  applyFilters();
});

function applyFilters() {
  const scac     = document.getElementById('filter-scac').value;
  const program  = document.getElementById('filter-program').value;
  const status   = document.getElementById('filter-status').value;
  const domicile = document.getElementById('filter-domicile').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo   = document.getElementById('filter-date-to').value;
  const search   = document.getElementById('filter-search').value.trim().toLowerCase();

  filtered = rawData.filter(row => {
    if (scac     !== 'All' && String(row[COL.scac]     ?? '').trim() !== scac)     return false;
    if (program  !== 'All' && String(row[COL.program]  ?? '').trim() !== program)  return false;
    if (status   !== 'All' && String(row[COL.status]   ?? '').trim() !== status)   return false;
    if (domicile !== 'All' && String(row[COL.domicile] ?? '').trim() !== domicile) return false;

    if (dateFrom || dateTo) {
      const d = parseDate(row[COL.scheduledDate]);
      if (d) {
        if (dateFrom && d < new Date(dateFrom)) return false;
        if (dateTo   && d > new Date(dateTo + 'T23:59:59')) return false;
      }
    }

    if (search) {
      const haystack = [
        row[COL.equipmentId], row[COL.vin], row[COL.licensePlate],
        row[COL.scac], row[COL.domicile]
      ].join(' ').toLowerCase();
      if (!haystack.includes(search)) return false;
    }

    return true;
  });

  renderKPIs();
  renderCharts();
  renderTable();
}

/* ============================================================
   DATE HELPER
   ============================================================ */
function parseDate(val) {
  if (!val) return null;
  if (val instanceof Date) return val;
  const d = new Date(val);
  return isNaN(d) ? null : d;
}

function toDateStr(val) {
  const d = parseDate(val);
  if (!d) return String(val ?? '');
  return d.toLocaleDateString();
}

/* ============================================================
   KPI CARDS
   ============================================================ */
function renderKPIs() {
  const total    = filtered.length;
  const done     = filtered.filter(r => /done/i.test(r[COL.status] ?? '')).length;
  const removed  = filtered.filter(r => /removed/i.test(r[COL.status] ?? '')).length;
  const replaced = filtered.filter(r => /replaced/i.test(r[COL.status] ?? '')).length;
  const scheduled = filtered.filter(r => r[COL.scheduledDate]).length;
  const rate = total ? Math.round(done / total * 100) : 0;

  document.getElementById('kpi-total').textContent      = total.toLocaleString();
  document.getElementById('kpi-done').textContent       = done.toLocaleString();
  document.getElementById('kpi-removed').textContent    = removed.toLocaleString();
  document.getElementById('kpi-replaced').textContent   = replaced.toLocaleString();
  document.getElementById('kpi-scheduled').textContent  = scheduled.toLocaleString();
  document.getElementById('kpi-completion').textContent = rate + '%';
}

/* ============================================================
   CHARTS
   ============================================================ */
function countBy(col) {
  const map = {};
  filtered.forEach(r => {
    const k = String(r[col] ?? '').trim() || '(blank)';
    map[k] = (map[k] || 0) + 1;
  });
  return map;
}

function sortedEntries(map, limit = 20) {
  return Object.entries(map)
    .sort((a, b) => b[1] - a[1])
    .slice(0, limit);
}

const PALETTE = [
  '#003087','#f5a623','#198754','#dc3545','#0dcaf0',
  '#6f42c1','#fd7e14','#20c997','#e83e8c','#adb5bd',
  '#0d6efd','#ffc107','#6610f2','#d63384','#0dcaf0',
];

function getOrCreate(id, type, data, options) {
  const canvas = document.getElementById(id);
  const existing = Chart.getChart(canvas);
  if (existing) { existing.data = data; existing.update(); return existing; }
  return new Chart(canvas, { type, data, options });
}

function renderCharts() {
  /* Status pie */
  const statusMap = countBy(COL.status);
  const statusColors = Object.keys(statusMap).map(k => {
    if (/done/i.test(k))     return 'var(--done-color)';
    if (/removed/i.test(k))  return 'var(--removed-color)';
    if (/replaced/i.test(k)) return 'var(--replaced-color)';
    return 'var(--other-color)';
  });
  chartStatus = getOrCreate('chart-status', 'doughnut',
    { labels: Object.keys(statusMap), datasets: [{ data: Object.values(statusMap), backgroundColor: statusColors, borderWidth: 2 }] },
    { plugins: { legend: { position: 'bottom', labels: { boxWidth: 14 } } }, maintainAspectRatio: true }
  );

  /* SCAC bar */
  const scacEntries = sortedEntries(countBy(COL.scac));
  chartScac = getOrCreate('chart-scac', 'bar',
    { labels: scacEntries.map(e => e[0]), datasets: [{ label: 'Vehicles', data: scacEntries.map(e => e[1]), backgroundColor: '#003087' }] },
    { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, maintainAspectRatio: true }
  );

  /* Program bar */
  const progEntries = sortedEntries(countBy(COL.program));
  chartProgram = getOrCreate('chart-program', 'bar',
    { labels: progEntries.map(e => e[0]), datasets: [{ label: 'Vehicles', data: progEntries.map(e => e[1]), backgroundColor: '#f5a623' }] },
    { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, maintainAspectRatio: true }
  );

  /* Daily trend */
  const trendMap = {};
  filtered.forEach(r => {
    if (!/done/i.test(r[COL.status] ?? '')) return;
    const d = parseDate(r[COL.scheduledDate]);
    if (!d) return;
    const key = d.toISOString().slice(0, 10);
    trendMap[key] = (trendMap[key] || 0) + 1;
  });
  const trendKeys = Object.keys(trendMap).sort();
  chartTrend = getOrCreate('chart-trend', 'line',
    {
      labels: trendKeys,
      datasets: [{
        label: 'Done per day',
        data: trendKeys.map(k => trendMap[k]),
        borderColor: '#003087', backgroundColor: 'rgba(0,48,135,.12)',
        tension: 0.3, fill: true, pointRadius: 3,
      }]
    },
    { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, maintainAspectRatio: false }
  );

  /* Body type */
  const btEntries = sortedEntries(countBy(COL.bodyType), 10);
  chartBodyType = getOrCreate('chart-bodytype', 'bar',
    {
      labels: btEntries.map(e => e[0]),
      datasets: [{ label: 'Vehicles', data: btEntries.map(e => e[1]), backgroundColor: PALETTE }]
    },
    { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, ticks: { precision: 0 } } }, maintainAspectRatio: true }
  );
}

/* ============================================================
   TABLE
   ============================================================ */
/* Key columns shown by default (first 12 to keep table readable) */
const KEY_COLS = [
  COL.equipmentId, COL.program, COL.scac, COL.status,
  COL.scheduledDate, COL.domicile, COL.vin, COL.manufacture,
  COL.model, COL.modelYear, COL.bodyType, COL.verifiedIDMS,
];

function statusBadge(val) {
  const v = String(val ?? '').trim();
  if (/done/i.test(v))     return `<span class="badge badge-done">${v}</span>`;
  if (/removed/i.test(v))  return `<span class="badge badge-removed">${v}</span>`;
  if (/replaced/i.test(v)) return `<span class="badge badge-replaced">${v}</span>`;
  return v ? `<span class="badge badge-other">${v}</span>` : '';
}

function renderTable() {
  const head = document.getElementById('table-head-row');
  const body = document.getElementById('table-body');
  const badge = document.getElementById('table-count-badge');
  const noData = document.getElementById('no-data-msg');

  /* Determine columns available in this dataset */
  const available = KEY_COLS.filter(c => rawData.some(r => r[c] !== undefined && r[c] !== ''));

  head.innerHTML = available.map(c => `<th>${c}</th>`).join('');

  const rows = filtered.slice(0, 1000);
  badge.textContent = filtered.length.toLocaleString();

  if (!rows.length) {
    body.innerHTML = '';
    noData.style.display = 'block';
    return;
  }
  noData.style.display = 'none';

  body.innerHTML = rows.map(r => {
    const cells = available.map(c => {
      if (c === COL.status)        return `<td>${statusBadge(r[c])}</td>`;
      if (c === COL.scheduledDate) return `<td>${toDateStr(r[c])}</td>`;
      return `<td>${escHtml(String(r[c] ?? ''))}</td>`;
    }).join('');
    return `<tr>${cells}</tr>`;
  }).join('');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ============================================================
   EXPORT
   ============================================================ */
document.getElementById('btn-export-csv').addEventListener('click', () => {
  if (!filtered.length) return;

  /* Use all columns present in data */
  const cols = Object.keys(filtered[0]);
  const lines = [cols.map(csvCell).join(',')];
  filtered.forEach(r => {
    lines.push(cols.map(c => csvCell(String(r[c] ?? ''))).join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'dfw_pilot_filtered_' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
});

function csvCell(v) {
  const s = String(v).replace(/"/g,'""');
  return /[",\n]/.test(s) ? `"${s}"` : s;
}
</script>
</body>
</html>
